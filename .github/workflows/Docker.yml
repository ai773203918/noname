name: æ„å»º Dockeré•œåƒ  # Actionsåç§°ï¼Œdocker
on:
  # 1. å½“æ¨é€ç¬¦åˆ 'v*' æ¨¡å¼çš„æ ‡ç­¾æ—¶è§¦å‘ï¼ˆä¾‹å¦‚ v1.0.0, v2.1.3ï¼‰
  push:
    tags:
      - 'v*'
  # 2. å…è®¸åœ¨ GitHub Actions é¡µé¢ä¸Šæ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    # æ‰‹åŠ¨è§¦å‘æ—¶ï¼Œå¯ä»¥æä¾›è¾“å…¥å‚æ•°
    inputs:  # è¾“å…¥çš„å‚æ•°
      tag:  # è¾“å…¥çš„æ ‡ç­¾
        description: 'å‘å¸ƒçš„æ ‡ç­¾åç§°(ä¾‹å¦‚ v0.0.0)' # å‚æ•°æè¿°
        required: false # æ˜¯å¦ä¸ºå¿…å¡«é¡¹ï¼Œæ”¹ä¸ºfalseä»¥å…è®¸ä¸ºç©º
        default: '' # é»˜è®¤å€¼æ”¹ä¸ºç©º

# å¯ä»¥æœ‰å¤šä¸ªå·¥ä½œæµ,å¤šä¸ªå·¥ä½œæµä¾æ¬¡è¿è¡Œ
# ä¸€ä¸ªå·¥ä½œæµè¿è¡Œç”±ä¸€ä¸ªæˆ–å¤šä¸ªä½œä¸šç»„æˆï¼Œè¿™äº›ä½œä¸šå¯ä»¥é¡ºåºæˆ–å¹¶è¡Œè¿è¡Œ
jobs:  # å·¥ä½œæµä½œä¸š
  image:  # ä½œä¸šåç§°,å”¯ä¸€æ ‡è¯†
    name: ä» Dockerfile æ„å»ºæ˜ åƒ  # å·¥ä½œæµä½œä¸šåç§°
    runs-on: ubuntu-latest  # åœ¨æœ€æ–°çš„Ubuntuç¯å¢ƒä¸­è¿è¡Œ
    permissions:
      contents: read
      packages: write  # æ·»åŠ æƒé™ä»¥æ¨é€åˆ°GitHub Container Registry
    steps:  # å·¥ä½œæµæ­¥éª¤
      # æ£€å‡ºä»£ç 
      - name: æ£€æŸ¥ä»£ç æ˜¯å¦åœ¨å·¥ä½œç›®å½•  # æ­¥éª¤åç§°
        uses: actions/checkout@v4 # ä½¿ç”¨ v4 ç‰ˆæœ¬çš„ checkout action
        # with:
        #   # æŒ‡å®šè¦æ£€å‡ºçš„åˆ†æ”¯(å½“å‰æ„å»ºé•œåƒçš„åˆ†æ”¯ä½¿ç”¨çš„æ˜¯masterä¸»åˆ†æ”¯)
        #   ref: build-tooling

      # ğŸ‘‡ æ–°å¢æ­¥éª¤ï¼šæ¸…ç† Runner ç£ç›˜ç©ºé—´(é˜²æ­¢å¤šæ¶æ„æ„å»ºæ—¶ç£ç›˜ç©ºé—´ä¸è¶³)
      - name: æ¸…ç†ç£ç›˜ç©ºé—´
        # åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„é•œåƒ;å¼ºåˆ¶æ‰§è¡Œæ— éœ€ç¡®è®¤;åŒæ—¶æ¸…ç†æœªä½¿ç”¨çš„å·
        run: |
          echo "ğŸ§¹ æ¸…ç†æ—§çš„ Docker é•œåƒå’Œç¼“å­˜..."
          docker system prune -af --volumes
          echo "âœ… æ¸…ç†å®Œæˆ"
          df -h

      # è®¾ç½®QEMUï¼Œç”¨äºæ„å»ºå¤šå¹³å°é•œåƒ
      - name: è®¾ç½® QEMU  # æ­¥éª¤åç§°
        uses: docker/setup-qemu-action@v3  # å¼•ç”¨æµç¨‹

      # è®¾ç½®Docker Buildxï¼Œç”¨äºæ„å»ºå’Œæ¨é€å¤šå¹³å°é•œåƒï¼Œæ˜¾å¼åˆ›å»ºå¹¶ä½¿ç”¨å¤šå¹³å° builder
      - name: è®¾ç½® Docker Buildx  # æ­¥éª¤åç§°
        uses: docker/setup-buildx-action@v3  # å¼•ç”¨æµç¨‹
        with:
          # æŒ‡å®š builder çš„åç§°ï¼Œæ–¹ä¾¿åç»­å¼•ç”¨
          builder-name: multiarch-builder
          # ä½¿ç”¨ docker-container é©±åŠ¨ï¼Œè¿™æ˜¯è¿›è¡Œå¤šå¹³å°æ„å»ºæœ€å¯é çš„é©±åŠ¨
          driver: docker-container
          # ç¡®ä¿ builder æ˜¯å¯ç”¨çš„
          use: true
          # å¯åŠ¨æ—¶è‡ªåŠ¨æ„å»º
          buildkitd-flags: --allow-insecure-entitlement security.insecure --allow-insecure-entitlement network.host

      # è·å–å½“å‰æ—¥æœŸï¼ˆæ ¼å¼ï¼šå¹´æœˆæ—¥,å¦‚ 20251009ï¼‰
      - name: è·å–å½“å‰æ—¥æœŸ
        id: get-date
        run: echo "date=$(date +%Y%m%d)" >> $GITHUB_OUTPUT
        shell: bash

      # è·å–é•œåƒæ ‡ç­¾åç§°
      - name: è·å– Image Tag  # æ­¥éª¤åç§°
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            # å¦‚æœæ˜¯pushè§¦å‘ï¼Œä½¿ç”¨æ ‡ç­¾å
            echo "TAG_NAME=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV
          elif [ -n "${{ github.event.inputs.tag }}" ]; then
            # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”å¡«å†™äº†æ ‡ç­¾ï¼Œä½¿ç”¨å¡«å†™çš„æ ‡ç­¾
            echo "TAG_NAME=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
          else
            # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”æ²¡æœ‰å¡«å†™æ ‡ç­¾ï¼Œä½¿ç”¨å½“å‰æ—¥æœŸ
            echo "TAG_NAME=${{ steps.get-date.outputs.date }}" >> $GITHUB_ENV
          fi

      # ç™»å½•åˆ°Docker Hub
      - name: ç™»å½• DockerHub  # æ­¥éª¤åç§°
        uses: docker/login-action@v3  # å¼•ç”¨æµç¨‹
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}  # Docker Hub ç”¨æˆ·å(éœ€åœ¨secretsä¸­é…ç½®)
          password: ${{ secrets.DOCKERHUB_PASSWORD }}  # Docker Hub Token(éœ€åœ¨secretsä¸­é…ç½®)

      # ç™»å½•åˆ°GitHub Container Registry
      - name: ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUBTOKEN }}  # ä¿®æ­£ä¸ºæ­£ç¡®çš„tokenåç§°

      # å‡†å¤‡é•œåƒæ ‡ç­¾
      - name: è®¾ç½® Image Tags  # æ­¥éª¤åç§°
        run: |
          echo "TAG=${{ secrets.DOCKERHUB_USERNAME }}/noname:${{ env.TAG_NAME }}" >> $GITHUB_ENV
          echo "TAG_LATEST=${{ secrets.DOCKERHUB_USERNAME }}/noname:latest" >> $GITHUB_ENV
          # æ·»åŠ GitHub Container Registryæ ‡ç­¾
          echo "GHCR_TAG=ghcr.io/${{ github.repository }}:${{ env.TAG_NAME }}" >> $GITHUB_ENV
          echo "GHCR_TAG_LATEST=ghcr.io/${{ github.repository }}:latest" >> $GITHUB_ENV

      # # æ„å»ºå¹¶æ¨é€é•œåƒ(å¤šå¹³å°ä¸€æ¬¡æ€§æ„å»ºçˆ†å†…å­˜äº†)
      # - name: ç¼–è¯‘å¹¶æ¨é€ nonameé•œåƒ  # æ­¥éª¤åç§°
      #   uses: docker/build-push-action@v5  # å¼•ç”¨æµç¨‹
      #   with:  # å‚æ•°
      #     context: .  # æ„å»ºä¸Šä¸‹æ–‡
      #     file: ./Dockerfile  # æŒ‡å®šçš„Dockerfile
      #     # platforms: linux/amd64  # æ„å»ºçš„å¹³å°(æµ‹è¯•æ„å»º,å°‘ä¸€äº›å¿«ä¸€ç‚¹),å¤šæ¶æ„ä¸€èˆ¬å–å†³äºä½¿ç”¨çš„åŸºç¡€é•œåƒæ”¯æŒæ¶æ„
      #     platforms: linux/amd64,linux/arm64/v8,linux/arm/v7,linux/arm/v6  # æ„å»ºçš„å¹³å°(æ­£å¼æ„å»º,æŒ‰éœ€ä¿ç•™,é•œåƒè¿‡å¤§å¤šäº†ä¼šçˆ†å†…å­˜)
      #     push: true  # æ¨é€åˆ°ä»“åº“
      #     tags: |
      #       ${{ env.TAG }}
      #       ${{ env.TAG_LATEST }}
      #       ${{ env.GHCR_TAG }}
      #       ${{ env.GHCR_TAG_LATEST }}
      #     # é…ç½® GitHub Actions ç¼“å­˜(é˜²æ­¢å¤šæ¶æ„æ„å»ºæ—¶ç©ºé—´ä¸è¶³)
      #     cache-from: type=gha  # æ„å»ºå‰å°è¯•ä» GitHub Actions ç¼“å­˜ä¸­æ‹‰å–ä¹‹å‰çš„ç¼“å­˜
      #     cache-to: type=gha,mode=max  # æ„å»ºæˆåŠŸåå°†æ–°çš„ç¼“å­˜å±‚æ¨é€åˆ° GitHub Actions ç¼“å­˜æœåŠ¡;ä¼šç¼“å­˜å°½å¯èƒ½å¤šçš„å±‚ï¼Œæœ€å¤§åŒ–ç¼“å­˜æ•ˆæœ

      # ä¾æ¬¡æ„å»º
      - name: ç¼–è¯‘å¹¶æ¨é€ nonameé•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64 # ğŸ‘ˆ åªæŒ‡å®šä¸€ä¸ªå¹³å°
          push: true
          builder: multiarch-builder
          tags: |
            ${{ env.TAG }}
            ${{ env.TAG_LATEST }}
            ${{ env.GHCR_TAG }}
            ${{ env.GHCR_TAG_LATEST }}
          cache-from: type=gha
      # ä¾æ¬¡æ„å»º
      - name: ç¼–è¯‘å¹¶æ¨é€ nonameé•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/arm64/v8 # ğŸ‘ˆ åªæŒ‡å®šä¸€ä¸ªå¹³å°
          push: true
          builder: multiarch-builder
          tags: |
            ${{ env.TAG }}
            ${{ env.TAG_LATEST }}
            ${{ env.GHCR_TAG }}
            ${{ env.GHCR_TAG_LATEST }}
          cache-from: type=gha
      # ä¾æ¬¡æ„å»º
      - name: ç¼–è¯‘å¹¶æ¨é€ nonameé•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/arm/v7 # ğŸ‘ˆ åªæŒ‡å®šä¸€ä¸ªå¹³å°
          push: true
          builder: multiarch-builder
          tags: |
            ${{ env.TAG }}
            ${{ env.TAG_LATEST }}
            ${{ env.GHCR_TAG }}
            ${{ env.GHCR_TAG_LATEST }}
          cache-from: type=gha

      # Ghcr.io è‡ªåŠ¨å…¬å¼€åŒ–æ­¥éª¤(ä¹Ÿå¯æ‰‹åŠ¨æ“ä½œ)
      - name: å°† Ghcr.io åŒ…è®¾ç½®ä¸ºå…¬å¼€
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          gh package edit noname --repo ${{ github.repository }} --visibility public
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUBTOKEN }}  # ä¿®æ­£ä¸ºæ­£ç¡®çš„tokenåç§°

      # # é•œåƒæ‰“åŒ…ä¸ºtaråŒ…
      # - name: é•œåƒæ‰“åŒ…ä¸ºtaråŒ…  # æ­¥éª¤åç§°
      #   run: |
      #     docker save -o noname.tar ${{ secrets.DOCKERHUB_USERNAME }}/noname:latest

      # # å°†æ„å»ºå¥½çš„é•œåƒå¯¼å‡ºä¸ºtaråŒ…
      # - name: Archive å¯¼å‡ºå†…éƒ¨æ–‡ä»¶  # æ­¥éª¤åç§°
      #   uses: actions/upload-artifact@v4  # å¼•ç”¨æµç¨‹
      #   with:  # å‚æ•°
      #     name: noname.tar  # å¯¼å‡ºçš„æ–‡ä»¶åç§°
      #     path: noname.tar  # å¯¼å‡ºçš„æ–‡ä»¶è·¯å¾„
