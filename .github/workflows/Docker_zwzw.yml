name: æ„å»º Dockeré•œåƒ  # Actionsåç§°ï¼Œdocker
on:
  # 1. å½“æ¨é€ç¬¦åˆ 'v*' æ¨¡å¼çš„æ ‡ç­¾æ—¶è§¦å‘ï¼ˆä¾‹å¦‚ v1.0.0, v2.1.3ï¼‰
  push:
    tags:
      - 'v*'
  # 2. å…è®¸åœ¨ GitHub Actions é¡µé¢ä¸Šæ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    # æ‰‹åŠ¨è§¦å‘æ—¶ï¼Œå¯ä»¥æä¾›è¾“å…¥å‚æ•°
    inputs:  # è¾“å…¥çš„å‚æ•°
      tag:  # è¾“å…¥çš„æ ‡ç­¾
        description: 'å‘å¸ƒçš„æ ‡ç­¾åç§°(ä¾‹å¦‚ v0.0.0)' # å‚æ•°æè¿°
        required: false # æ˜¯å¦ä¸ºå¿…å¡«é¡¹ï¼Œæ”¹ä¸ºfalseä»¥å…è®¸ä¸ºç©º
        default: '' # é»˜è®¤å€¼æ”¹ä¸ºç©º
jobs:  # å·¥ä½œæµä½œä¸šï¼Œæ”¯æŒå¤šä¸ªä½œä¸šï¼Œæ¯ä¸ªä½œä¸šå¯ä»¥ç‹¬ç«‹è¿è¡Œ
  server-image:
    name: æ„å»º å•åç«¯ Docker é•œåƒ  # å·¥ä½œæµä½œä¸šåç§°
    runs-on: ubuntu-latest  # åœ¨æœ€æ–°çš„Ubuntuç¯å¢ƒä¸­è¿è¡Œ
    permissions:
      contents: read
      packages: write  # æ·»åŠ æƒé™ä»¥æ¨é€åˆ°GitHub Container Registry
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€æŸ¥ä»£ç æ˜¯å¦åœ¨å·¥ä½œç›®å½•  # æ­¥éª¤åç§°
        uses: actions/checkout@v4 # ä½¿ç”¨ v4 ç‰ˆæœ¬çš„ checkout action
        # with:
        #   # æŒ‡å®šè¦æ£€å‡ºçš„åˆ†æ”¯(å½“å‰æ„å»ºé•œåƒçš„åˆ†æ”¯ä½¿ç”¨çš„æ˜¯masterä¸»åˆ†æ”¯)
        #   ref: build-tooling

      # æ¸…ç† Runner ç£ç›˜ç©ºé—´(é˜²æ­¢å¤šæ¶æ„æ„å»ºæ—¶ç£ç›˜ç©ºé—´ä¸è¶³)
      - name: æ¸…ç†ç£ç›˜ç©ºé—´
        # åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„é•œåƒ;å¼ºåˆ¶æ‰§è¡Œæ— éœ€ç¡®è®¤;åŒæ—¶æ¸…ç†æœªä½¿ç”¨çš„å·
        run: |
          echo "ğŸ§¹ æ¸…ç†æ—§çš„ Docker é•œåƒå’Œç¼“å­˜..."
          docker system prune -af --volumes
          echo "âœ… æ¸…ç†å®Œæˆ"
          df -h

      # è®¾ç½®QEMUï¼Œç”¨äºæ„å»ºå¤šå¹³å°é•œåƒ
      - name: è®¾ç½® QEMU  # æ­¥éª¤åç§°
        uses: docker/setup-qemu-action@v3  # å¼•ç”¨æµç¨‹

      # è®¾ç½®Docker Buildxï¼Œç”¨äºæ„å»ºå’Œæ¨é€å¤šå¹³å°é•œåƒ
      - name: è®¾ç½® Docker Buildx  # æ­¥éª¤åç§°
        uses: docker/setup-buildx-action@v3  # å¼•ç”¨æµç¨‹

      # è·å–å½“å‰æ—¥æœŸï¼ˆæ ¼å¼ï¼šå¹´æœˆæ—¥,å¦‚ 20251009ï¼‰
      - name: è·å–å½“å‰æ—¥æœŸ
        id: get-date
        run: echo "date=$(date +%Y%m%d)" >> $GITHUB_OUTPUT
        shell: bash

      # è·å–é•œåƒæ ‡ç­¾åç§°
      - name: è·å– Image Tag  # æ­¥éª¤åç§°
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            # å¦‚æœæ˜¯pushè§¦å‘ï¼Œä½¿ç”¨æ ‡ç­¾å
            echo "TAG_NAME=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV
          elif [ -n "${{ github.event.inputs.tag }}" ]; then
            # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”å¡«å†™äº†æ ‡ç­¾ï¼Œä½¿ç”¨å¡«å†™çš„æ ‡ç­¾
            echo "TAG_NAME=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
          else
            # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”æ²¡æœ‰å¡«å†™æ ‡ç­¾ï¼Œä½¿ç”¨å½“å‰æ—¥æœŸ
            echo "TAG_NAME=${{ steps.get-date.outputs.date }}" >> $GITHUB_ENV
          fi

      # ç™»å½•åˆ°Docker Hub
      - name: ç™»å½• DockerHub  # æ­¥éª¤åç§°
        uses: docker/login-action@v3  # å¼•ç”¨æµç¨‹
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}  # Docker Hub ç”¨æˆ·å(éœ€åœ¨secretsä¸­é…ç½®)
          password: ${{ secrets.DOCKERHUB_PASSWORD }}  # Docker Hub Token(éœ€åœ¨secretsä¸­é…ç½®)

      # ç™»å½•åˆ°GitHub Container Registry
      - name: ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUBTOKEN }}  # ä¿®æ­£ä¸ºæ­£ç¡®çš„tokenåç§°

      # å‡†å¤‡é•œåƒæ ‡ç­¾
      - name: è®¾ç½® Server é•œåƒæ ‡ç­¾
        run: |
          echo "SERVER_TAG=${{ secrets.DOCKERHUB_USERNAME }}/noname:server-${{ env.TAG_NAME }}" >> $GITHUB_ENV
          echo "SERVER_TAG_LATEST=${{ secrets.DOCKERHUB_USERNAME }}/noname:server-latest" >> $GITHUB_ENV
          # æ·»åŠ GitHub Container Registryæ ‡ç­¾
          echo "SERVER_GHCR_TAG=ghcr.io/${{ github.repository }}:server-${{ env.TAG_NAME }}" >> $GITHUB_ENV
          echo "SERVER_GHCR_TAG_LATEST=ghcr.io/${{ github.repository }}:server-latest" >> $GITHUB_ENV

      # æ„å»ºå¹¶æ¨é€é•œåƒ(å¤šå¹³å°ä¸€æ¬¡æ€§æ„å»ºçˆ†å†…å­˜äº†)
      - name: ç¼–è¯‘å¹¶æ¨é€ nonameé•œåƒ  # æ­¥éª¤åç§°
        uses: docker/build-push-action@v5  # å¼•ç”¨æµç¨‹
        with:  # å‚æ•°
          context: .  # æ„å»ºä¸Šä¸‹æ–‡
          file: ./Dockerfile_Server  # æŒ‡å®šServerçš„Dockerfile
          # platforms: linux/amd64  # æ„å»ºçš„å¹³å°(æµ‹è¯•æ„å»º,å°‘ä¸€äº›å¿«ä¸€ç‚¹),å¤šæ¶æ„ä¸€èˆ¬å–å†³äºä½¿ç”¨çš„åŸºç¡€é•œåƒæ”¯æŒæ¶æ„
          platforms: linux/amd64,linux/arm64/v8,linux/arm/v7,linux/arm/v6,linux/ppc64le,linux/s390x  # æ„å»ºçš„å¹³å°(æ­£å¼æ„å»º,æŒ‰éœ€ä¿ç•™,é•œåƒè¿‡å¤§å¤šäº†ä¼šçˆ†å†…å­˜)
          push: true  # æ¨é€åˆ°ä»“åº“
          tags: |
            ${{ env.SERVER_TAG  }}
            ${{ env.SERVER_TAG_LATEST }}
            ${{ env.SERVER_GHCR_TAG }}
            ${{ env.SERVER_GHCR_TAG_LATEST }}
          # é…ç½® GitHub Actions ç¼“å­˜(é˜²æ­¢å¤šæ¶æ„æ„å»ºæ—¶ç©ºé—´ä¸è¶³)
          cache-from: type=gha  # æ„å»ºå‰å°è¯•ä» GitHub Actions ç¼“å­˜ä¸­æ‹‰å–ä¹‹å‰çš„ç¼“å­˜
  image:  # ä½œä¸šåç§°,å”¯ä¸€æ ‡è¯†
    name: æ„å»º å‰åç«¯äºŒåˆä¸€ Docker é•œåƒ  # å·¥ä½œæµä½œä¸šåç§°
    runs-on: ubuntu-latest  # åœ¨æœ€æ–°çš„Ubuntuç¯å¢ƒä¸­è¿è¡Œ
    # needs: server-image  # ç­‰å¾…å‰é¢ä½œä¸šå®Œæˆ,ç¡®ä¿ç©ºé—´è¶³å¤Ÿ
    permissions:
      contents: read
      packages: write  # æ·»åŠ æƒé™ä»¥æ¨é€åˆ°GitHub Container Registry
    steps:  # å·¥ä½œæµæ­¥éª¤
      # æ£€å‡ºä»£ç 
      - name: æ£€æŸ¥ä»£ç æ˜¯å¦åœ¨å·¥ä½œç›®å½•  # æ­¥éª¤åç§°
        uses: actions/checkout@v4 # ä½¿ç”¨ v4 ç‰ˆæœ¬çš„ checkout action
        # with:
        #   # æŒ‡å®šè¦æ£€å‡ºçš„åˆ†æ”¯(å½“å‰æ„å»ºé•œåƒçš„åˆ†æ”¯ä½¿ç”¨çš„æ˜¯masterä¸»åˆ†æ”¯)
        #   ref: build-tooling

      # æ¸…ç† Runner ç£ç›˜ç©ºé—´(é˜²æ­¢å¤šæ¶æ„æ„å»ºæ—¶ç£ç›˜ç©ºé—´ä¸è¶³)
      - name: æ¸…ç†ç£ç›˜ç©ºé—´
        # åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„é•œåƒ;å¼ºåˆ¶æ‰§è¡Œæ— éœ€ç¡®è®¤;åŒæ—¶æ¸…ç†æœªä½¿ç”¨çš„å·
        run: |
          echo "ğŸ§¹ æ¸…ç†æ—§çš„ Docker é•œåƒå’Œç¼“å­˜..."
          docker system prune -af --volumes
          echo "âœ… æ¸…ç†å®Œæˆ"
          df -h

      # è®¾ç½®QEMUï¼Œç”¨äºæ„å»ºå¤šå¹³å°é•œåƒ
      - name: è®¾ç½® QEMU  # æ­¥éª¤åç§°
        uses: docker/setup-qemu-action@v3  # å¼•ç”¨æµç¨‹

      # è®¾ç½®Docker Buildxï¼Œç”¨äºæ„å»ºå’Œæ¨é€å¤šå¹³å°é•œåƒ
      - name: è®¾ç½® Docker Buildx  # æ­¥éª¤åç§°
        uses: docker/setup-buildx-action@v3  # å¼•ç”¨æµç¨‹

      # è·å–å½“å‰æ—¥æœŸï¼ˆæ ¼å¼ï¼šå¹´æœˆæ—¥,å¦‚ 20251009ï¼‰
      - name: è·å–å½“å‰æ—¥æœŸ
        id: get-date
        run: echo "date=$(date +%Y%m%d)" >> $GITHUB_OUTPUT
        shell: bash

      # è·å–é•œåƒæ ‡ç­¾åç§°
      - name: è·å– Image Tag  # æ­¥éª¤åç§°
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            # å¦‚æœæ˜¯pushè§¦å‘ï¼Œä½¿ç”¨æ ‡ç­¾å
            echo "TAG_NAME=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV
          elif [ -n "${{ github.event.inputs.tag }}" ]; then
            # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”å¡«å†™äº†æ ‡ç­¾ï¼Œä½¿ç”¨å¡«å†™çš„æ ‡ç­¾
            echo "TAG_NAME=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
          else
            # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”æ²¡æœ‰å¡«å†™æ ‡ç­¾ï¼Œä½¿ç”¨å½“å‰æ—¥æœŸ
            echo "TAG_NAME=${{ steps.get-date.outputs.date }}" >> $GITHUB_ENV
          fi

      # ç™»å½•åˆ°Docker Hub
      - name: ç™»å½• DockerHub  # æ­¥éª¤åç§°
        uses: docker/login-action@v3  # å¼•ç”¨æµç¨‹
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}  # Docker Hub ç”¨æˆ·å(éœ€åœ¨secretsä¸­é…ç½®)
          password: ${{ secrets.DOCKERHUB_PASSWORD }}  # Docker Hub Token(éœ€åœ¨secretsä¸­é…ç½®)

      # ç™»å½•åˆ°GitHub Container Registry
      - name: ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUBTOKEN }}  # ä¿®æ­£ä¸ºæ­£ç¡®çš„tokenåç§°

      # å‡†å¤‡é•œåƒæ ‡ç­¾
      - name: è®¾ç½® Image Tags  # æ­¥éª¤åç§°
        run: |
          echo "TAG=${{ secrets.DOCKERHUB_USERNAME }}/noname:${{ env.TAG_NAME }}" >> $GITHUB_ENV
          echo "TAG_LATEST=${{ secrets.DOCKERHUB_USERNAME }}/noname:latest" >> $GITHUB_ENV
          # æ·»åŠ GitHub Container Registryæ ‡ç­¾
          echo "GHCR_TAG=ghcr.io/${{ github.repository }}:${{ env.TAG_NAME }}" >> $GITHUB_ENV
          echo "GHCR_TAG_LATEST=ghcr.io/${{ github.repository }}:latest" >> $GITHUB_ENV

      # æ„å»ºå¹¶æ¨é€é•œåƒ(å¤šå¹³å°ä¸€æ¬¡æ€§æ„å»ºçˆ†å†…å­˜äº†)
      - name: ç¼–è¯‘å¹¶æ¨é€ nonameé•œåƒ  # æ­¥éª¤åç§°
        uses: docker/build-push-action@v5  # å¼•ç”¨æµç¨‹
        with:  # å‚æ•°
          context: .  # æ„å»ºä¸Šä¸‹æ–‡
          file: ./Dockerfile  # æŒ‡å®šçš„Dockerfile
          # platforms: linux/amd64  # æ„å»ºçš„å¹³å°(æµ‹è¯•æ„å»º,å°‘ä¸€äº›å¿«ä¸€ç‚¹),å¤šæ¶æ„ä¸€èˆ¬å–å†³äºä½¿ç”¨çš„åŸºç¡€é•œåƒæ”¯æŒæ¶æ„
          platforms: linux/amd64,linux/arm64/v8,linux/arm/v7  # æ„å»ºçš„å¹³å°(æ­£å¼æ„å»º,æŒ‰éœ€ä¿ç•™,é•œåƒè¿‡å¤§å¤šäº†ä¼šçˆ†å†…å­˜)
          push: true  # æ¨é€åˆ°ä»“åº“
          tags: |
            ${{ env.TAG }}
            ${{ env.TAG_LATEST }}
            ${{ env.GHCR_TAG }}
            ${{ env.GHCR_TAG_LATEST }}
          # é…ç½® GitHub Actions ç¼“å­˜(é˜²æ­¢å¤šæ¶æ„æ„å»ºæ—¶ç©ºé—´ä¸è¶³)
          cache-from: type=gha  # æ„å»ºå‰å°è¯•ä» GitHub Actions ç¼“å­˜ä¸­æ‹‰å–ä¹‹å‰çš„ç¼“å­˜

      # - name: éªŒè¯é•œåƒå¤§å°
      #   run: |
      #     echo "ğŸ“Š é•œåƒå¤§å°ç»Ÿè®¡:"
      #     docker images | grep noname
      #     echo "âœ… Server é•œåƒæ„å»ºå®Œæˆ"

      # Ghcr.io è‡ªåŠ¨å…¬å¼€åŒ–æ­¥éª¤(ä¹Ÿå¯æ‰‹åŠ¨æ“ä½œ)
      - name: å°† Ghcr.io åŒ…è®¾ç½®ä¸ºå…¬å¼€
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          gh package edit noname --repo ${{ github.repository }} --visibility public
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUBTOKEN }}  # ä¿®æ­£ä¸ºæ­£ç¡®çš„tokenåç§°

  # # å¯é€‰ï¼šç”Ÿæˆæ„å»ºæŠ¥å‘Š
  # build-report:
  #   name: ç”Ÿæˆæ„å»ºæŠ¥å‘Š
  #   runs-on: ubuntu-latest
  #   needs: [main-image, server-image]
  #   if: always()

  #   steps:
  #     - name: ç”Ÿæˆæ„å»ºæŠ¥å‘Š
  #       run: |
  #         echo "ğŸ—ï¸ æ„å»ºæŠ¥å‘Š"
  #         echo "ä¸»é•œåƒä½œä¸šçŠ¶æ€: ${{ needs.main-image.result }}"
  #         echo "Serveré•œåƒä½œä¸šçŠ¶æ€: ${{ needs.server-image.result }}"
  #         echo "ğŸ“… æ„å»ºæ—¶é—´: $(date)"
  #         echo "ğŸ”– æ ‡ç­¾: ${{ github.ref }}"
